jobs:
  compliance:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install OPA + conftest + jq
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64_static
          chmod +x opa && sudo mv opa /usr/local/bin/opa
          wget -q https://github.com/open-policy-agent/conftest/releases/download/v0.45.0/conftest_0.45.0_Linux_x86_64.tar.gz
          tar xzf conftest_0.45.0_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/conftest
          sudo apt-get update && sudo apt-get install -y jq

      - name: Validate ALN patterns
        run: .bit/loaders/validate_adaptable_patterns.sh

      - name: Verify Lisp sources
        run: .bit/loaders/lisp_verify.sh

      - name: Run Bit.Hub policies (OPA)
        run: conftest test --policy .bithub/policies .

      - name: Upload compliance reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compliance-reports
          path: |
            .bithub/reports/**
            .bithub/ledger/compliance.log
          if-no-files-found: warn
          retention-days: 7

- name: Scan for failed jobs
  run: |
    for script in bithub/scripts/get_failed_jobs.py \
                  bithub/scripts/get_failed_jobs_alt1.py \
                  bithub/scripts/get_failed_jobs_alt2.py \
                  bithub/scripts/get_failed_jobs_stub.py; do
      if [ -f "$script" ]; then
        echo "Running $script..."
        python "$script" > failed_jobs.json && break
      fi
    done
