name: Preflight Namespace & Workflow Autoâ€‘Fix

on:
  workflow_call:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  preflight-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ”’ Bit.Hub .bit Architecture Guard
      - name: Enforce immutable .bit architecture (ALN compliance)
        shell: pwsh
        run: |
          Write-Host "ğŸ” Validating .bit architecture modal..."
          
          # Ensure .bit directory exists
          if (-not (Test-Path ".bit")) {
              Write-Error "âŒ .bit directory missing â€” required for Bit.Hub compliance."
              exit 1
          }

          # Ensure all files in .bit have .bit extension
          $invalidFiles = Get-ChildItem -Path ".bit" -Recurse -File | Where-Object { $_.Extension -ne ".bit" }
          if ($invalidFiles) {
              Write-Error "âŒ Found files in .bit without .bit extension:"
              $invalidFiles | ForEach-Object { Write-Host " - $($_.FullName)" }
              exit 1
          }

          # Ensure .bit manifests are not modified outside policy
          if (git diff --name-only origin/main...HEAD | Where-Object { $_ -like ".bit/*" }) {
              Write-Host "ğŸ“œ Changes detected in .bit â€” verifying policy..."
              # Example: enforce read-only except via approved bot commits
              $lastCommitAuthor = git log -1 --pretty=format:'%an'
              if ($lastCommitAuthor -notmatch "github-actions

\[bot\]

|BitBot") {
                  Write-Error "âŒ Unauthorized modification to .bit manifests."
                  exit 1
              }
          }

          Write-Host "âœ… .bit architecture validated."

      # ğŸ›  Autoâ€‘fix namespace & workflows
      - name: Preflight namespace & workflow autoâ€‘fix
        shell: pwsh
        run: |
          $hasUnstaged = (git status --porcelain | Select-String '^[ M]\s').Count -gt 0
          $hasStaged   = (git diff --cached --name-only).Count -gt 0
          
          if (-not $hasStaged -and $hasUnstaged) {
              Write-Host "ğŸ“Œ Unstaged changes found â€” autoâ€‘adding to index..."
              git add -A
          }
          
          if (git diff --cached --quiet) {
              Write-Host "âœ… No staged changes to commit."
              exit 0
          }

          Write-Host "ğŸ“¦ Committing staged changes..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "ci(preflight): autoâ€‘fix namespaces & sync workflows [skip ci]" || exit 0
          
          Write-Host "â¬‡ï¸ Fetching latest main..."
          git fetch origin main
          
          Write-Host "ğŸ“¤ Rebasing and pushing..."
          git pull --rebase origin main
          git push origin main

      # ğŸ’¤ Stale issue cleanup
      - name: Close stale issues and PRs
        uses: actions/stale@v9.1.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          days-before-stale: 60
          days-before-close: 7
          stale-issue-message: "This issue has been automatically marked as stale due to inactivity."
          stale-pr-message: "This pull request has been automatically marked as stale due to inactivity."
          close-issue-message: "Closing this issue due to prolonged inactivity."
          close-pr-message: "Closing this pull request due to prolonged inactivity."

      # ğŸ“Š Postâ€‘fix report
      - name: Report postâ€‘fix status
        run: |
          echo "Postâ€‘fix HEAD: $(git rev-parse HEAD)"
          echo "Branch: $(git branch --show-current)"
